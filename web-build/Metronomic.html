<html> 
<head>
<!--
	// Metronomic v1.1 Web Version - 13 Dec 2014
	// Programmed by: Jeffrey Qua <jeffrey.qua@gmail.com>
	// Web version
-->
<style type="text/css"> 
body { 
	margin: 0;
} 

#front {
	height: 200px;
	background: url(Default.png) no-repeat;
	display: block;
	position: relative;
}

#canvas {
	z-index: 1;
}

#trigger_btn {
	width: 60px;
	position: absolute;
	bottom: 15px;
	left: 70px;

	color: black;
}

#bpc_select {
	position: absolute;
	bottom: 56px;
	left: 55px;
	
	opacity: 0.0;
	z-index: 3;
}

#bpc_select_textbox {
	position: absolute;
	bottom: 60px;
	left: 65px;
	
	text-align: center;
	color: #343434;
	text-shadow: 1px 1px 0 white;
	font: 12px "Helvetica";
	font-weight: bold;
	
	z-index: 2;
}

#bpc_select_bg {
	position: absolute;
	bottom: 58px;
	left: 53px;
	
	z-index: 1;
}

#bpc_label {
	position: absolute;
	bottom: 59px;
	left: 115px;
	
	color: #343434;
	text-shadow: 1px 1px 0 white;
	font: 12px "Helvetica";
	font-weight: bold;
}

#bpm_select {
	position: absolute;
	bottom: 46px;
	left: 55px;
	
	opacity: 0.0;
	z-index: 3;
}

#bpm_select_textbox {
	position: absolute;
	bottom: 50px;
	left: 65px;
	
	text-align: center;
	color: #343434;
	text-shadow: 1px 1px 0 white;
	font: 12px "Helvetica";
	font-weight: bold;
	
	z-index: 2;
}

#bpm_select_bg {
	position: absolute;
	bottom: 48px;
	left: 53px;
	
	z-index: 1;
}

#bpm_label {
	position: absolute;
	bottom: 49px;
	left: 115px;
	
	color: #343434;
	text-shadow: 1px 1px 0 white;
	font: 12px "Helvetica";
	font-weight: bold;
}


#count {
	position: absolute;
	top: 10px;
	left: 85px;

	text-align: center;
	color: #06C;
	font: 40px "Helvetica";
	font-weight: bold;
	text-shadow: #AAA 1px 1px 1px;
}
</style>

<script type="text/javascript">
	var bpmArray = new Array();
	// metronome vars:
	var c=0;
	var t; // metronome beat interval
	var animation_interval; // metronome animation interval
	var lock = 0; // if set to 1, it means that nothing has changed, 0 means the interval needs to be refreshed to the new bpm
	var cur_vis = 2;
	// Visualization constants:
	var VIS_SQUARE = 0;
	var VIS_COUNT = 1;
	var VIS_ANALOG = 2;
	var VIS_NUM_VISUALIZATIONS = 3;
	
	var VIS_ANALOG_MAX_ANGLE = 50;
	var VIS_ANALOG_FPS = 60;
	
	// square visualization-->
	var vis_square_metroY = 65;
	var vis_square_metroXdefault = 93;
	var vis_square_metroXoffset = 30;
	var vis_square_curPos = true;
	
	// count visualization-->
	var vis_count_count = 1;
	// beats per cycle
	var vis_count_bpc = 4;
	
	// analog visualization -->
	// vertical offset:
	var vis_analog_metroYoffset = 105;
	// current angle:
	var vis_analog_curAngle = 0;
	// current rotation direction:
	var vis_analog_dir = true;
	
	// default BPM value
	var currentBPM = 60; 
	var animateTempo = currentBPM; // this is to prevent our animation timer from being affected
	
	// convert degree value into radian units
	function degree2rad(degree) {
		return degree / 180 * Math.PI;
	}
	
	// create the BPM array options
	function generateBPMArray() {
		// Range of values: 40-208
		var granularity = 4;
		var range_min = 40;
		var range_max = 208;
		
		var i;	
		for (i = range_min; i <= range_max; i+=granularity) {
			bpmArray[i] = i;
		}
	}
	
	// write the BPM array options
	function writeBPMArray() {		
		for (var x in bpmArray)
		{
			document.write('<option value="' + bpmArray[x] + '"');
			if (bpmArray[x] == currentBPM) {
				document.write(' selected');
			}
			document.writeln('>' + bpmArray[x] + "</option>");
		}	
	}
	
	// write the BPC array options
	function writeBPCArray() {
		for (var i=1; i<=32; i++)
		{
			document.write('<option value="' + i + '"');
			if (i == vis_count_bpc) {
				document.write(' selected');
			}
			document.writeln('>' + i + "</option>");
		}	
	}
	
	// refresh the current BPM values
	function refreshBPM() {
		// bpm dropdown has just been altered, so access that form element and set current BPM
		currentBPM = document.metronomeForm.bpm_select.value;
		document.getElementById("bpm_select_textbox").innerHTML = currentBPM;
		// timer needs to refresh
		lock = 0;
	}
	
	// refresh the current BPC values
	function refreshBPC() {
		// bpc dropdown has just been altered, so access that form element and set current BPC
		vis_count_bpc = document.metronomeForm.bpc_select.value;
		document.getElementById("bpc_select_textbox").innerHTML = vis_count_bpc;
	}
	
	// create and write out the visualization array options
	function writeVisualizationArray() {
		var write_vis = 0;
		
		// load preferences
		if(window.widget) {
			var temp_vis = widget.preferenceForKey("cur_vis");
			
			// VALID preference
			if (temp_vis >= 0 && temp_vis < VIS_NUM_VISUALIZATIONS) {
				write_vis = temp_vis;
			}
		}
		
		//SQUARE
		document.write('<option value="' + VIS_SQUARE + '"');
		if (write_vis == VIS_SQUARE) {
			document.write(' selected');
		}
		document.writeln('>' + "Square" + "</option>");
		
		//COUNT
		document.write('<option value="' + VIS_COUNT + '"');
		if (write_vis == VIS_COUNT) {
			document.write(' selected');
		}
		document.writeln('>' + "Count" + "</option>");
		
		// ANALOG
		
		document.write('<option value="' + VIS_ANALOG + '"');
		if (write_vis == VIS_ANALOG) {
			document.write(' selected');
		}
		document.writeln('>' + "Analog" + "</option>");
		
	}
	
	
	// show beats per cycle controls
	function showBPCcontrols() {
		// Move BPM down
		var bpmtext = document.getElementById("bpm_select_textbox");
		var bpmselect = document.getElementById("bpm_select");
		var bpmselectbg = document.getElementById("bpm_select_bg");
		var bpmlabel = document.getElementById("bpm_label");
		
		bpmtext.style.bottom = 40 + "px";
		bpmselect.style.bottom = 36 + "px";
		bpmselectbg.style.bottom = 38 + "px";
		bpmlabel.style.bottom = 39 + "px";
		
		// show BPC
		var bpctext = document.getElementById("bpc_select_textbox");
		var bpcselect = document.getElementById("bpc_select");
		var bpcselectbg = document.getElementById("bpc_select_bg");
		var bpclabel = document.getElementById("bpc_label");

		bpctext.style.display = "block";
		bpcselect.style.display = "block";
		bpcselectbg.style.display = "block";
		bpclabel.style.display = "block";
	}
	
	// hide beats per cycle controls
	function hideBPCcontrols() {
		// Move BPM to default
		var bpmtext = document.getElementById("bpm_select_textbox");
		var bpmselect = document.getElementById("bpm_select");
		var bpmselectbg = document.getElementById("bpm_select_bg");
		var bpmlabel = document.getElementById("bpm_label");
		
		bpmtext.style.bottom = 50 + "px";
		bpmselect.style.bottom = 46 + "px";
		bpmselectbg.style.bottom = 48 + "px";
		bpmlabel.style.bottom = 49 + "px";
		
		// hide BPC
		var bpctext = document.getElementById("bpc_select_textbox");
		var bpcselect = document.getElementById("bpc_select");
		var bpcselectbg = document.getElementById("bpc_select_bg");
		var bpclabel = document.getElementById("bpc_label");
		
		bpctext.style.display = "none";
		bpcselect.style.display = "none";
		bpcselectbg.style.display = "none";
		bpclabel.style.display = "none";
	}
	
	// Setup initial load
	function setup() 
	{
		// Clear the screen
		clear();
		
		// Set preferences:
		// set bpm at 60 (default) when widget has just been opened
		currentBPM = 60;
		// make sure the textbox is showing:
		refreshBPM();
		
		// set bpc at 4 (default) when widget has just been opened
		vis_count_bpc = 4;
		// make sure the textbox is showing:
		refreshBPC();
		
		// refresh controls
		showBPCcontrols();
	}
	
	// canvas:
	
	// clear the screen
	function clear() {
		var canvas = document.getElementById("canvas"); 
		var ctx = canvas.getContext("2d"); 
		
		// clear canvas
		ctx.clearRect(0, 0, 200, 200);
		ctx.save();
		
		// clear count
		var counter = document.getElementById("count_text");
		counter.innerHTML = "";
	}
	
	// draw the metronome with square visualization
	function drawMetronome () {

		var canvas = document.getElementById("canvas"); 
		var ctx = canvas.getContext("2d"); 
		
		ctx.clearRect(0, 0, 200, 200);
		ctx.save();
		
		// Start Translation
		if (vis_square_curPos) {
			vis_square_metroX = vis_square_metroXdefault - vis_square_metroXoffset;
		}
		else {
			vis_square_metroX = vis_square_metroXdefault + vis_square_metroXoffset;
		}
		vis_square_curPos = !vis_square_curPos;
		
		ctx.translate(vis_square_metroX, vis_square_metroY);
		ctx.save();
		// End Translation

		ctx.fillStyle = "rgb(0,102,204)";
		ctx.fillRect(0, 0, 10, 10);
		
		ctx.restore();
		ctx.restore();
	}
	
	// draw the metronome with count visualization
	function countMetronome() {

		// initiate count
		var counter = document.getElementById("count_text");
		

		//vis_count_count = ( vis_count_count + vis_count_bpc + 1) % vis_count_bpc;
		counter.innerHTML = vis_count_count;
		
		if (vis_count_count > 9) {
			document.getElementById("count").style.left = 76 + "px";
		}
		else {
			document.getElementById("count").style.left = 86 + "px";
		}
	}
	
	// draw the metronome with the analog visualization
	function analogMetronome() 
	{
		// Boundary switch:
		// Play sound and switch direction
		
		var canvas = document.getElementById("canvas"); 
		var ctx = canvas.getContext("2d"); 
	
		ctx.clearRect(0, 0, 200, 200);
		ctx.save();
		
		ctx.translate(100, vis_analog_metroYoffset);
		ctx.save();
		
		// vertical pointing up
		ctx.rotate(degree2rad(180)); 
		
		// max left rotation angle / minimum
		if (vis_analog_dir) {
			vis_analog_curAngle = -VIS_ANALOG_MAX_ANGLE;
			ctx.rotate(degree2rad(-VIS_ANALOG_MAX_ANGLE)); 
		}
		else {
			vis_analog_curAngle = VIS_ANALOG_MAX_ANGLE;
			ctx.rotate(degree2rad(VIS_ANALOG_MAX_ANGLE)); 
		}
		
		
		// Draw Needle -->
		ctx.fillStyle = "rgb(0,102,204)";
		ctx.beginPath();
		
		ctx.moveTo(0, 0);
		ctx.lineTo(3, 3);
		ctx.lineTo(0, 68);
		ctx.lineTo(-3, 3);
		ctx.lineTo(0, 0);
		 
		ctx.fill();
		// <-- End Needle
		ctx.restore(); 
		ctx.restore();
		
		// Reverse direction
		vis_analog_dir = !vis_analog_dir;
	}
	
	// update the analog metronome
	function analogAnimate() {
		var canvas = document.getElementById("canvas"); 
		var ctx = canvas.getContext("2d");
	
		ctx.clearRect(0, 0, 200, 200);
		ctx.save();
		
		ctx.translate(100, vis_analog_metroYoffset);
		ctx.save();
		
		// vertical pointing up
		ctx.rotate(degree2rad(180));
		
		// Apply rotation:
		// Alpha = Frames / Beat
		// Alpha = FPS / (BPM * 60) [beats per second]
		// Angle granularity = VIS_ANALOG_MAX_ANGLE / Alpha;
		var alpha = VIS_ANALOG_FPS / animateTempo * 60;
		var slice = (2*VIS_ANALOG_MAX_ANGLE)/alpha;
		if (!vis_analog_dir) {
			vis_analog_curAngle += slice;
			ctx.rotate(degree2rad(vis_analog_curAngle));
		}
		// going the other way
		else {
			vis_analog_curAngle -= slice;
			ctx.rotate(degree2rad(vis_analog_curAngle));
		}
		
		// Draw Needle -->
		ctx.fillStyle = "rgb(0,102,204)";
		ctx.beginPath();
		
		ctx.moveTo(0, 0);
		ctx.lineTo(3, 3);
		ctx.lineTo(0, 68);
		ctx.lineTo(-3, 3);
		ctx.lineTo(0, 0);
		 
		ctx.fill();
		// <-- End Needle
		ctx.restore(); 
		ctx.restore();
		
	}
	
	// clear the sound to play the next tick
	function clear_sound() {
		document.tickSound.stop();
		document.tick2Sound.stop();
	}
	
	// convert the bpm value to a millisecond delay time
	function bpm_to_ms(bpm) {
		return 60000/bpm;
	}
	
	// trigger action based on the button push
	function buttonTrigger() {
		// always reset the count
		vis_count_count = 0;
		// reset analog position
		vis_analog_curAngle = 0;
		vis_analog_dir = true;
		lock = 0;
		
		if(document.metronomeForm.trigger_btn.value == "Start") {
			document.metronomeForm.trigger_btn.value = "Stop";
			//animator();
			//interval = setInterval("animator()", 60000/bpm);
			metronomeTimer();
		}
		else {
			document.metronomeForm.trigger_btn.value = "Start";
			clearInterval(t);
			clearInterval(animation_interval);
			//clearTimeout(t);
			clear();
		}
	}
	
	// timer algorithm loop to refresh the metronome
	function metronomeTimer() {
		// increment
		vis_count_count++;

		if (vis_count_count > vis_count_bpc) {
			vis_count_count = 1;
		}
		clearInterval(animation_interval);
		animateTempo = currentBPM;
		
		// clear sound
		// clear_sound();


		
		if (vis_count_count==1) {
			document.getElementById('tick2Sound').play();
		}
		else {
			document.getElementById('tickSound').play();
		}
			
		if (cur_vis == VIS_SQUARE) {
			drawMetronome();
		}
		else if (cur_vis == VIS_COUNT) {
			countMetronome();
		}
		else if (cur_vis == VIS_ANALOG) {
			animation_interval = setInterval("analogAnimate()", 1000/VIS_ANALOG_FPS);
			analogMetronome();
		}
		
		// lock = 0 means that we need to re-set the interval
		if (lock==0) {
			clearInterval(t);
			t = setInterval("metronomeTimer()", bpm_to_ms(currentBPM));
			lock = 1;
		}
	}
	
	// Event keys:
	function checkKey(e) {
		if (e.keyCode == 13) {
			refreshBPM();
		}
		else if (e.keyCode == 32) {
			buttonTrigger();
		}
	}
	
	// String trim function
	String.prototype.trim = function() {
		return this.replace(/^\s*|\s*$/g, "")
	}
	
	// End update script
</script>

</head> 
  
<body onload="setup()" onkeydown="checkKey(event)"> 
	<div id="front">
	<div id="infoButton"></div>
		<audio id="tickSound">
	  		<source src="tick.wav" type="audio/wav">
		</audio>
		<audio id="tick2Sound">
	  		<source src="tick2.wav" type="audio/wav">
		</audio>

   	<!-- Your widget’s front side here -->
		<canvas id="canvas" width="200" height="200"></canvas>
		<div id="count"><p id="count_text"></p></div>
		<form name="metronomeForm">
			<span id="bpc_select_textbox"></span>
			<img id="bpc_select_bg" alt="select_bg" src="Select.png" />
			<select id="bpc_select" name="bpc_select" size="1" onchange="refreshBPC()">
				<script type="text/javascript">
					writeBPCArray();
				</script>
			</select>
			<span id="bpc_label">BPM</span>
			
			<span id="bpm_select_textbox"></span>
			<img id="bpm_select_bg" alt="select_bg" src="Select.png" />
			<select id="bpm_select" name="bpm_select" size="1" onchange="refreshBPM()">
				<script type="text/javascript">
					generateBPMArray();
					writeBPMArray();
				</script>
			</select>
			<input type="button" id="trigger_btn" value="Start" name="trigger_btn" onclick="buttonTrigger()" />
		</form>
		<span id="bpm_label">Tempo</span>
	</div>
</body> 
</html> 
